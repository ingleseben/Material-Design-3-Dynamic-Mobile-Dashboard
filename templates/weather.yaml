# Weather Template Sensors

- sensor:
     - name: "Outdoor Temperature"
       unique_id: outdoor_temperature
       unit_of_measurement: "¬∞C"
       state: >
          {{ state_attr('weather.home', 'temperature') }}
       device_class: temperature

     - name: "Outdoor Humidity"
       unique_id: outdoor_humidity
       unit_of_measurement: "%"
       state: >
          {{ state_attr('weather.home', 'humidity') }}
       device_class: humidity

     - name: "Weather Condition Icon"
       unique_id: weather_condition_icon
       state: >
        {% set condition = states('weather.home') | lower %}
        {% if condition in ['sunny', 'clear'] %}
          mdi:weather-sunny
        {% elif condition == 'clear-night' %}
          mdi:weather-night
        {% elif condition in ['partlycloudy', 'partly cloudy'] %}
          mdi:weather-partly-cloudy
        {% elif condition == 'cloudy' %}
          mdi:weather-cloudy
        {% elif condition in ['rainy', 'rain'] %}
          mdi:weather-rainy
        {% elif condition == 'pouring' %}
          mdi:weather-pouring
        {% elif condition == 'windy' %}
          mdi:weather-windy
        {% elif condition in ['fog', 'foggy'] %}
          mdi:weather-fog
        {% elif condition in ['snow', 'snowy'] %}
          mdi:weather-snowy
        {% elif condition == 'snowy-rainy' %}
          mdi:weather-snowy-rainy
        {% elif condition == 'hail' %}
          mdi:weather-hail
        {% elif condition == 'lightning' %}
          mdi:weather-lightning
        {% elif condition == 'lightning-rainy' %}
          mdi:weather-lightning-rainy
        {% elif condition == 'windy-variant' %}
          mdi:weather-windy-variant
        {% elif condition == 'exceptional' %}
          mdi:alert-circle-outline
        {% else %}
          mdi:weather-cloudy-alert
        {% endif %}

     - name: "Rainfall Forecast Today"
       unique_id: rainfall_forecast_today
       state: >
          {% set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') %}
          {% if forecasts %}
            {% set total = forecasts | map(attribute='precipitation') | map('float') | sum %}
            {% if total == 0 %}
              none
            {% elif total < 2.5 %}
              light
            {% elif total < 7.6 %}
              moderate
            {% elif total < 35 %}
              heavy
            {% else %}
              very_heavy
            {% endif %}
          {% else %}
            none
          {% endif %}

- sensor:
    - name: "Forecast UV Index"
      unique_id: forecast_uv_index
      unit_of_measurement: "UV"
      state: >
        {% set f = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast', 'forecasts') %}
        {% if f is sequence and f | count > 0 %}
          {{ f[0].uv_index }}
        {% else %}
          unknown
        {% endif %}

    - name: "Forecast Cloud Coverage"
      unique_id: forecast_cloud_coverage
      unit_of_measurement: "%"
      state: >
        {% set f = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast', 'forecasts') %}
        {% if f is sequence and f | count > 0 %}
          {{ f[0].cloud_coverage }}
        {% else %}
          unknown
        {% endif %}

    - name: "Forecast Rainfall"
      unique_id: forecast_rainfall
      unit_of_measurement: "mm"
      state: >
        {% set f = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast', 'forecasts') %}
        {% if f is sequence and f | count > 0 %}
          {{ f[0].precipitation }}
        {% else %}
          unknown
        {% endif %}

    - name: "Forecast Wind Speed"
      unique_id: forecast_wind_speed
      unit_of_measurement: "km/h"
      state: >
        {{ state_attr('weather.home', 'wind_speed') }}

    - name: "Forecast Wind Direction"
      unique_id: forecast_wind_direction
      unit_of_measurement: "¬∞"
      state: >
        {{ state_attr('weather.home', 'wind_bearing') }}

    - name: "Forecast Temperature"
      unique_id: forecast_temperature
      unit_of_measurement: "¬∞C"
      state: >
        {{ state_attr('weather.home', 'temperature') }}

    - name: "Next Rain Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set rain_forecasts = forecasts | selectattr('precipitation','defined') | selectattr('precipitation','gt',0) | list -%}
        {%- if rain_forecasts | count > 0 -%}
        {%- set next_rain = rain_forecasts | first -%}
        {%- set val = next_rain.precipitation | float -%}
        {%- if val < 2.5 -%}üå¶Ô∏è Light ¬∑ {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} ¬∑ {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- elif val < 7.6 -%}üåßÔ∏è Moderate ¬∑ {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} ¬∑ {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- elif val < 35 -%}‚õàÔ∏è Heavy ¬∑ {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} ¬∑ {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- else -%}‚õàÔ∏è Very heavy ¬∑ {{ val | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} ¬∑ {{ as_datetime(next_rain.datetime).strftime('%a, %b %d at %I:%M %p') }}
        {%- endif -%}
        {%- else -%}üå§Ô∏è No rain today{%- endif -%}
        {%- else -%}üå§Ô∏è N/A{%- endif -%}

    - name: "24h Rainfall Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set values = forecasts | map(attribute='precipitation') | map('float') | list -%}
        {%- set total = values | sum -%}
        {%- set peak = values | max -%}
        {%- set peak_entry = forecasts | selectattr('precipitation','eq', peak) | list | first -%}
        {%- if total == 0 -%}üå§Ô∏è Rainfall: None expected in the next 24 hours
        {%- else -%}
        {%- if total < 2.5 -%}{%- set category = 'Light' -%}{%- set emoji = 'üå¶Ô∏è' -%}
        {%- elif total < 7.6 -%}{%- set category = 'Moderate' -%}{%- set emoji = 'üåßÔ∏è' -%}
        {%- elif total < 35 -%}{%- set category = 'Heavy' -%}{%- set emoji = '‚õàÔ∏è' -%}
        {%- else -%}{%- set category = 'Very heavy' -%}{%- set emoji = 'üåä' -%}{%- endif -%}
        {{- emoji }} Rainfall: {{ total | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }} ({{ category }}), peaking {{ peak | round(1) }} {{ state_attr('weather.home', 'precipitation_unit') }}/hr on {{ as_datetime(peak_entry.datetime).strftime('%a, %b %d at %I:%M %p') }}.
        {%- endif -%}
        {%- else -%}üå§Ô∏è Rainfall: N/A{%- endif -%}

    - name: "UV and Cloud Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set uv_values = forecasts | map(attribute='uv_index') | map('float') | list -%}
        {%- set peak_uv = uv_values | max -%}
        {%- set peak_entry = forecasts | selectattr('uv_index','eq', peak_uv) | list | first -%}
        {%- set cloud_values = forecasts | map(attribute='cloud_coverage') | map('float') | list -%}
        {%- set avg_cloud = (cloud_values | sum / cloud_values | length) -%}
        {%- if peak_uv < 3 -%}{%- set uv_category = 'Low' -%}{%- set uv_emoji = 'üü¢' -%}
        {%- elif peak_uv < 6 -%}{%- set uv_category = 'Moderate' -%}{%- set uv_emoji = 'üü°' -%}
        {%- elif peak_uv < 8 -%}{%- set uv_category = 'High' -%}{%- set uv_emoji = 'üü†' -%}
        {%- elif peak_uv < 11 -%}{%- set uv_category = 'Very High' -%}{%- set uv_emoji = 'üî¥' -%}
        {%- else -%}{%- set uv_category = 'Extreme' -%}{%- set uv_emoji = 'üü£' -%}{%- endif -%}
        {%- if avg_cloud <= 25 -%}{%- set cloud_category = 'Clear' -%}{%- set cloud_emoji = '‚òÄÔ∏è' -%}
        {%- elif avg_cloud <= 50 -%}{%- set cloud_category = 'Partly Cloudy' -%}{%- set cloud_emoji = 'üå§Ô∏è' -%}
        {%- elif avg_cloud <= 75 -%}{%- set cloud_category = 'Mostly Cloudy' -%}{%- set cloud_emoji = '‚õÖ' -%}
        {%- else -%}{%- set cloud_category = 'Overcast' -%}{%- set cloud_emoji = '‚òÅÔ∏è' -%}{%- endif -%}
        {{- uv_emoji }} Peak UV: {{ peak_uv | round(1) }} ({{ uv_category }}), {{ cloud_emoji }} Avg Cloud: {{ avg_cloud | round(0) }}% ({{ cloud_category }}), peaking at {{ as_datetime(peak_entry.datetime).strftime('%a, %b %d at %I:%M %p') }}.
        {%- else -%}üå§Ô∏è UV & Cloud Forecast: N/A{%- endif -%}

    - name: "Wind Summary"
      state: >
        {%- set forecasts = state_attr('sensor.google_weather_hourly_forecasts_full_hourly_forecast','forecasts') -%}
        {%- if forecasts -%}
        {%- set speeds = forecasts | map(attribute='wind_speed') | map('float') | list -%}
        {%- set peak = speeds | max -%}
        {%- set peak_entry = forecasts | selectattr('wind_speed','eq', peak) | list | first -%}
        {%- set avg_bearing = (forecasts | map(attribute='wind_bearing') | list | sum / forecasts | length) -%}
        {%- set direction = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][(avg_bearing / 22.5) | round(0) % 16] -%}
        {%- if peak < 2 -%}{%- set category = 'Calm' -%}{%- set emoji = 'üå´Ô∏è' -%}
        {%- elif peak < 6 -%}{%- set category = 'Light breeze' -%}{%- set emoji = 'üçÉ' -%}
        {%- elif peak < 12 -%}{%- set category = 'Gentle breeze' -%}{%- set emoji = 'üåø' -%}
        {%- elif peak < 20 -%}{%- set category = 'Moderate breeze' -%}{%- set emoji = 'üå¨Ô∏è' -%}
        {%- elif peak < 29 -%}{%- set category = 'Fresh breeze' -%}{%- set emoji = 'üí®' -%}
        {%- elif peak < 39 -%}{%- set category = 'Strong breeze' -%}{%- set emoji = 'üí®' -%}
        {%- elif peak < 50 -%}{%- set category = 'Near gale' -%}{%- set emoji = 'üå™Ô∏è' -%}
        {%- elif peak < 62 -%}{%- set category = 'Gale' -%}{%- set emoji = 'üå™Ô∏è' -%}
        {%- elif peak < 75 -%}{%- set category = 'Strong gale' -%}{%- set emoji = 'üå™Ô∏è' -%}
        {%- else -%}{%- set category = 'Storm' -%}{%- set emoji = 'üåÄ' -%}{%- endif -%}
        {{- emoji }} Winds: {{ peak | round(1) }} {{ state_attr('weather.home', 'wind_speed_unit') }} ({{ category }}), mostly from {{ direction }}, peaking at {{ as_datetime(peak_entry.datetime).strftime('%a, %b %d at %I:%M %p') }}.
        {%- else -%}üå§Ô∏è Winds: N/A{%- endif -%}

    - name: "Moon Summary"
      state: >
        {%- set rise = states('sensor.morrinsville_moon_rise') -%}
        {%- set set_ = states('sensor.morrinsville_moon_set') -%}
        {%- set next_full = states('sensor.morrinsville_next_full_moon') -%}
        {%- set phase = states('sensor.morrinsville_moon_phase') or 'Unknown' -%}
        {%- set phase_emoji = {
          'New Moon':'üåë','Waxing Crescent':'üåí','First Quarter':'üåì','Waxing Gibbous':'üåî',
          'Full Moon':'üåï','Waning Gibbous':'üåñ','Last Quarter':'üåó','Waning Crescent':'üåò'
        } -%}
        {%- set emoji = phase_emoji.get(phase,'üåô') -%}
        {%- if rise not in ['unknown','unavailable','none',''] and set_ not in ['unknown','unavailable','none',''] -%}
        {{- emoji }} {{ phase | replace('_',' ') | title }} ‚Äì rises {{ as_local(as_datetime(rise)).strftime('%I:%M %p') }}, sets {{ as_local(as_datetime(set_)).strftime('%I:%M %p') }}, next üåï {{ as_local(as_datetime(next_full)).strftime('%a, %b %d') }}.
        {%- else -%}üåô Moon data unavailable{%- endif -%}

# Trigger-based weather forecast extraction sensors
- trigger:
    - platform: time_pattern
      minutes: /15
    - platform: homeassistant
      event: start

  sensor:
    - name: "Hourly Weather Data - Google Weather"
      unique_id: hourly_weather_data_google_weather
      state: >
        {% if forecast['weather.home'].forecast is defined
              and forecast['weather.home'].forecast | length > 0 %}
          {{ as_local(strptime(forecast['weather.home'].forecast[0].datetime,
                               '%Y-%m-%dT%H:%M:%S%z')) }}
        {% else %}
          unknown
        {% endif %}
      attributes:
        forecast_data: >
          {% if forecast['weather.home'].forecast is defined
                and forecast['weather.home'].forecast | length > 0 %}
            {{ forecast['weather.home'].forecast[0] }}
          {% else %}
            {}
          {% endif %}

    - name: "Daily Weather Data - Google Weather"
      unique_id: daily_weather_data_google_weather
      state: >
        {% if forecast_daily['weather.home'].forecast is defined
              and forecast_daily['weather.home'].forecast | length > 0 %}
          {{ as_local(strptime(forecast_daily['weather.home'].forecast[0].datetime,
                               '%Y-%m-%dT%H:%M:%S%z')) }}
        {% else %}
          unknown
        {% endif %}
      attributes:
        forecast_data: >
          {% if forecast_daily['weather.home'].forecast is defined
                and forecast_daily['weather.home'].forecast | length > 0 %}
            {{ forecast_daily['weather.home'].forecast[0] }}
          {% else %}
            {}
          {% endif %}

  action:
    - action: weather.get_forecasts
      target:
        entity_id: weather.home
      data:
        type: hourly
      response_variable: forecast

    - action: weather.get_forecasts
      target:
        entity_id: weather.home
      data:
        type: daily
      response_variable: forecast_daily

- trigger:
    - platform: time_pattern
      minutes: /15
    - platform: homeassistant
      event: start

  sensor:
    - name: "Google Weather Hourly Forecasts (Full Hourly Forecast)"
      unique_id: google_weather_hourly_forecasts_full_hourly_forecast
      state: >
        {% if forecast['weather.home'].forecast is defined
              and forecast['weather.home'].forecast | length > 0 %}
          {{ as_local(strptime(forecast['weather.home'].forecast[0].datetime,
                               '%Y-%m-%dT%H:%M:%S%z')) }}
        {% else %}
          unknown
        {% endif %}
      attributes:
        forecasts: >
          {% if forecast['weather.home'].forecast is defined
                and forecast['weather.home'].forecast | length > 0 %}
            [
            {%- for f in forecast['weather.home'].forecast %}
              {
                "datetime": "{{ as_local(strptime(f.datetime, '%Y-%m-%dT%H:%M:%S%z')) }}",
                "condition": "{{ f.condition }}",
                "temperature": {{ f.temperature }},
                "precipitation": {{ f.precipitation }},
                "wind_speed": {{ f.wind_speed }},
                "wind_bearing": {{ f.wind_bearing }},
                "humidity": {{ f.humidity if f.humidity is defined else 'null' }},
                "cloud_coverage": {{ f.cloud_coverage if f.cloud_coverage is defined else 'null' }},
                "uv_index": {{ f.uv_index if f.uv_index is defined else 'null' }}
              }{{ "," if not loop.last }}
            {%- endfor %}
            ]
          {% else %}
            []
          {% endif %}

  action:
    - action: weather.get_forecasts
      target:
        entity_id: weather.home
      data:
        type: hourly
      response_variable: forecast
